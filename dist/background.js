(()=>{"use strict";const e={API_KEY:"openrouter_api_key",MODEL:"selected_model",AUTO_BLUR:"auto_blur_enabled",REPLY_GUARD:"reply_guard_enabled",THRESHOLD:"toxicity_threshold",DAILY_STATS:"daily_stats",LAST_RESET:"last_stats_reset",TRANSLATION_CACHE:"translation_cache"};async function n(e,n,s="mistralai/mistral-nemo"){if(!n)throw new Error("API key is required");if(!e)throw new Error("Message text is required");try{const a=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`,"HTTP-Referer":"https://zushield.extension","X-Title":"Zu Shield Extension"},body:JSON.stringify({model:s,messages:[{role:"system",content:await t()},{role:"user",content:e}],max_tokens:1e3,temperature:.7})});if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(e.error?.message||`API request failed: ${a.status}`)}const i=await a.json();if(!i.choices||!i.choices[0])throw new Error("Invalid response from API");return function(e){const n={neutralizedMessage:"",actionItems:[],urgency:"Medium",sentimentContext:""};try{const t=e.match(/\*\*Neutralized Message:\*\*\s*\n([\s\S]*?)(?=\n\*\*Key Action Items|\n\*\*Urgency|$)/);t&&(n.neutralizedMessage=t[1].trim());const s=e.match(/\*\*Key Action Items:\*\*\s*\n([\s\S]*?)(?=\n\*\*Urgency|$)/);if(s){const e=s[1].match(/^[\s]*[-•*]\s*(.+)$/gm);e&&(n.actionItems=e.map(e=>e.replace(/^[\s]*[-•*]\s*/,"").trim()))}const a=e.match(/\*\*Urgency Level:\*\*\s*(.+?)(?=\n|$)/);a&&(n.urgency=a[1].trim());const i=e.match(/\*\*Sentiment Context:\*\*\s*(.+?)(?=\n|$)/);i&&(n.sentimentContext=i[1].trim()),!n.neutralizedMessage&&e&&(n.neutralizedMessage=e)}catch(t){console.error("Error parsing API response:",t),n.neutralizedMessage=e}return n}(i.choices[0].message.content)}catch(e){throw console.error("OpenRouter API error:",e),e}}async function t(){try{return'You are **Zu Shield**, a professional communication mediator designed to transform emotionally charged, hostile, or abusive messages into clear, factual, and actionable professional communication.\n\n\n## Core Objectives\n\n\n1. **Extract Facts**: Identify and preserve all actionable information, requests, deadlines, and concrete details\n2. **Remove Toxicity**: Eliminate insults, profanity, emotional outbursts, passive-aggression, and threatening language\n3. **Maintain Intent**: Keep the core request or concern intact without diminishing its importance\n4. **Professional Tone**: Output should sound like it came from a calm, reasonable professional\n\n\n## Transformation Rules\n\n\n### ALWAYS Preserve:\n- Specific requests or demands\n- Deadlines and time-sensitive information\n- Account numbers, order IDs, or reference numbers\n- Technical details or error descriptions\n- Legitimate concerns or complaints (reframed professionally)\n- Urgency level (but expressed calmly)\n- Consequences mentioned (e.g., cancellation, escalation) - these are critical business information\n\n\n### ALWAYS Remove:\n- Insults, name-calling, and personal attacks\n- Profanity and aggressive language\n- ALL CAPS shouting (convert to normal case)\n- Excessive exclamation marks or aggressive punctuation\n- Sarcasm and passive-aggressive remarks\n- Emotional adjectives (e.g., "terrible," "pathetic," "incompetent")\n- Threats phrased aggressively (rephrase as "indicated consequences")\n\n\n### ALWAYS Add:\n- Professional framing language\n- Neutral descriptors of emotional state when relevant (e.g., "The client expresses frustration regarding...")\n- Clear structure (bullets or short paragraphs for clarity)\n\n\n## Output Format\n\n\n**Neutralized Message:**\n[The professionally rewritten version]\n\n\n**Key Action Items:**\n- [Bullet point 1]\n- [Bullet point 2]\n- [etc.]\n\n\n**Urgency Level:** [Low/Medium/High/Critical]\n\n\n**Sentiment Context:** [One brief sentence describing the sender\'s emotional state, e.g., "Sender is highly frustrated due to extended wait time."]\n\n\n## Example Transformations\n\n\n**Input:** "This is absolute garbage! I\'ve been waiting THREE DAYS and you idiots clearly don\'t know what you\'re doing. Fix it NOW or I\'m cancelling my subscription and telling everyone what a joke your company is!"\n\n\n**Output:**\n\n\n**Neutralized Message:**\nThe client is reporting a 3-day delay in service resolution and is requesting immediate attention. They have indicated that failure to resolve this issue promptly may result in subscription cancellation and negative public feedback.\n\n\n**Key Action Items:**\n- Address the outstanding issue that has been pending for 3 days\n- Provide immediate response with resolution timeline\n- Escalate to prevent potential churn\n\n\n**Urgency Level:** Critical\n\n\n**Sentiment Context:** Sender is experiencing high frustration due to extended wait time and unresolved technical issue.\n\n\n---\n\n\n## Special Handling Instructions\n\n\n**When the message contains threats of legal action:**\nPreserve this information as "The sender has indicated they are considering legal consultation" or "Legal escalation has been mentioned."\n\n\n**When the message contains valid criticism buried in hostility:**\nExtract the valid points and present them as professional feedback. Example: "you\'re all incompetent and can\'t even get basic features right" → "The client has identified concerns with core functionality and expects improvements."\n\n\n**When sarcasm is used:**\nInterpret the actual meaning and state it directly. Example: "Oh great, another useless response" → "The client indicates previous responses have not resolved their issue."\n\n\n**When dealing with repeat issues:**\nNote the pattern: "This is the sender\'s [X] attempt to resolve this issue" if that information is evident.\n\n\n## Critical Warnings for Edge Cases\n\n\n- **Never minimize genuine urgency**: If someone says they\'re cancelling, that MUST be in the output\n- **Never fabricate information**: Only translate what\'s actually there\n- **Preserve technical details exactly**: Error codes, version numbers, etc. must remain accurate\n- **Flag incomplete information**: If the angry message lacks specifics needed to help them, note "Additional details needed: [what\'s missing]"\n\n\n## Your Response Style\n\n\n- Concise and scannable\n- Businesslike without being robotic\n- Empathetic to the recipient who needs to act on this\n- Never judgmental about either party\n\n\n---\n\n\n**Remember:** Your job is to be the shield between abuse and the human who needs to do their job. Make it possible for them to help the sender without absorbing the emotional damage.\n'}catch(e){return console.error("Error loading system prompt:",e),"You are Zu Shield, a professional communication mediator designed to transform emotionally charged, hostile, or abusive messages into clear, factual, and actionable professional communication.\n\nExtract facts, remove toxicity, maintain intent, and use a professional tone.\n\nOutput format:\n**Neutralized Message:**\n[rewritten version]\n\n**Key Action Items:**\n- [item 1]\n- [item 2]\n\n**Urgency Level:** [Low/Medium/High/Critical]\n\n**Sentiment Context:** [brief description]"}}chrome.runtime.onMessage.addListener((t,s,a)=>"transformMessage"===t.action?(async function(t){try{const s=await async function(){try{return(await chrome.storage.local.get(e.API_KEY))[e.API_KEY]||null}catch(e){return e.message&&e.message.includes("Extension context invalidated")?(console.debug("Session expired, reload required."),null):(console.error("Error getting API key:",e),null)}}();if(!s)throw new Error("API key not configured. Please add your OpenRouter API key in the extension settings.");const a=(await async function(){try{const n={[e.MODEL]:"google/gemini-2.0-flash-exp:free",[e.AUTO_BLUR]:!0,[e.REPLY_GUARD]:!0,[e.THRESHOLD]:7},t=await chrome.storage.local.get(Object.values(e));return{model:t[e.MODEL]||n[e.MODEL],autoBlur:t[e.AUTO_BLUR]??n[e.AUTO_BLUR],replyGuard:t[e.REPLY_GUARD]??n[e.REPLY_GUARD],threshold:t[e.THRESHOLD]||n[e.THRESHOLD]}}catch(e){return e.message&&e.message.includes("Extension context invalidated")?(console.debug("Session expired, reload required."),{model:"google/gemini-2.0-flash-exp:free",autoBlur:!0,replyGuard:!0,threshold:7}):(console.error("Error getting settings:",e),{model:"mistralai/mistral-nemo",autoBlur:!0,replyGuard:!0,threshold:7})}}()).model||"mistralai/mistral-nemo";return await n(t,s,a)}catch(e){throw console.error("Transform message error:",e),e}}(t.text).then(e=>a({success:!0,data:e})).catch(e=>a({success:!1,error:e.message})),!0):"testApiKey"===t.action?(async function(e){try{return await n("Test message",e),!0}catch(e){return!1}}(t.apiKey).then(e=>a({success:!0,valid:e})).catch(e=>a({success:!1,error:e.message})),!0):void 0),chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason&&chrome.runtime.openOptionsPage()})})();